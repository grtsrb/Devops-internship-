name: 'Terraform Apply'
on:
    push:
        branches:
            - terraform-env
env:
    TF_CLOUD_ORGANIZATION: "Vlah"
    TF_API_TOKE: "${{ secrets.TF_API_TOKEN }}"
    TF_WORKSPACE: "python-web-github-actions"
    CONFIG_DIRECTORY: "./"
jobs:
    terraform:
        name: "Terraform apply"
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    ref: terraform-env
                    token: ${{ secrets.PAT }}
            -   name: Upload configuration
                uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.0.0
                id: plan-upload
                with:
                    workspace: ${{ env.TF_WORKSPACE }}
                    directory: ${{ env.CONFIG_DIRECTORY }}
                    speculative: true
            -   name: Create an apply run
                uses: hashicorp/tfc-workflows-github/actions/create-run@v1.0.0
                id: apply-run
                with:
                    workspace: ${{ env.TF_WORKSPACE }}
                    configuration_version: ${{ steps.plan-upload.outputs.configuration_version_id }}
            -   name: Apply
                uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.0.0
                if: fromJSON(steps.apply-run.outputs.payload).data.attributes.actions.IsConfirmable
                id: apply
                with:
                    run: ${{ steps.apply-run.outputs.run_id }}
                    comment: "Apply Run from GitHub Actions CI ${{ github.sha }}"